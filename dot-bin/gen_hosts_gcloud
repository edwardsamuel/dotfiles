#!/bin/bash

SEPARATOR='## Auto-generated by gen_hosts. Do not modified following lines.'
echo "${SEPARATOR}" > /tmp/hosts_gcloud

for i in "$@"
do
  PROJECT=$i
  echo "## Google Cloud Project: ${PROJECT}" | tee -a /tmp/hosts_gcloud
  gcloud compute instances list --project ${PROJECT} --sort-by name --format 'table[no-heading](networkInterfaces[0].networkIP, name, zone, machineType)' | awk -v OFS="\t" '{print $1, $2, "\t#-- " substr($0, index($0,$3))}' >> /tmp/hosts_gcloud
  echo "" >> /tmp/hosts_gcloud
done


( grep -B 10000 -m 1 "${SEPARATOR}" /etc/hosts || cat /etc/hosts ) | grep -v "${SEPARATOR}" > /tmp/hosts_orig
cat /tmp/hosts_orig /tmp/hosts_gcloud | sudo tee /etc/hosts
rm /tmp/hosts_orig /tmp/hosts_gcloud
